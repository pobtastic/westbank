<!DOCTYPE html>
<html>
<head>
<title>West Bank: Routine at D48F</title>
<meta charset="utf-8" />
<link rel="stylesheet" type="text/css" href="../westbank.css" />
<link rel="stylesheet" type="text/css" href="../skoolkit.css" />
<link rel="stylesheet" type="text/css" href="../skoolkit-dark.css" />
<link rel="stylesheet" type="text/css" href="../skoolkit-dark.css" />
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-75RERFCHBG"></script>
<script>
window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-75RERFCHBG');
</script>
</head>
<body class="Asm-c">
<table class="header">
<tr>
<td class="logo"><a href="../index.html"><img alt="logo" src="../images/logo.png" /></a></td>
<td class="page-header">Routines</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev">
Prev: <a href="D45E.html">D45E</a>
</td>
<td class="up">Up: <a href="../maps/all.html#d48f">Map</a></td>
<td class="next">
Next: <a href="D5A3.html">D5A3</a>
</td>
</tr>
</table>
<div class="description">D48F: Customer Logic.</div>
<table class="disassembly">
<tr>
<td class="routine-comment" colspan="5">
<div class="details">
</div>
</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="d48f"></span>
<div class="comments">
<div class="paragraph">
Character state variables/ flags.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label">CUSTOMER_FRAME_1</td>
<td class="address-2"><span id="d48f"></span>D48F</td>
<td class="instruction">DEFB $03</td>
<td class="comment-1" rowspan="1">Character frame index 1.</td>
</tr>
<tr>
<td class="asm-label">CUSTOMER_FRAME_2</td>
<td class="address-1"><span id="d490"></span>D490</td>
<td class="instruction">DEFB $04</td>
<td class="comment-1" rowspan="1">Character frame index 2.</td>
</tr>
<tr>
<td class="asm-label">CUSTOMER_FRAME_3</td>
<td class="address-1"><span id="d491"></span>D491</td>
<td class="instruction">DEFB $05</td>
<td class="comment-1" rowspan="1">Character frame index 3.</td>
</tr>
<tr>
<td class="asm-label">CUSTOMER_FRAME_4</td>
<td class="address-1"><span id="d492"></span>D492</td>
<td class="instruction">DEFB $06</td>
<td class="comment-1" rowspan="1">Character frame index 4.</td>
</tr>
<tr>
<td class="asm-label">CUSTOMER_FRAME_5</td>
<td class="address-1"><span id="d493"></span>D493</td>
<td class="instruction">DEFB $07</td>
<td class="comment-1" rowspan="1">Character frame index 5.</td>
</tr>
<tr>
<td class="asm-label">CUSTOMER_FLAG_UNCOVER</td>
<td class="address-1"><span id="d494"></span>D494</td>
<td class="instruction">DEFB $01</td>
<td class="comment-1" rowspan="1">Represents whether the customer will move to uncover a bandit ($00 "normal" / $01 "uncover" action).</td>
</tr>
<tr>
<td class="asm-label">CUSTOMER_STATE_REF</td>
<td class="address-1"><span id="d495"></span>D495</td>
<td class="instruction">DEFB $02</td>
<td class="comment-1" rowspan="1">The current character state.</td>
</tr>
<tr>
<td class="asm-label">CUSTOMER_1_TIMER</td>
<td class="address-1"><span id="d496"></span>D496</td>
<td class="instruction">DEFB $0B</td>
<td class="comment-1" rowspan="1">Character timer 1.</td>
</tr>
<tr>
<td class="asm-label">CUSTOMER_2_TIMER</td>
<td class="address-1"><span id="d497"></span>D497</td>
<td class="instruction">DEFB $00</td>
<td class="comment-1" rowspan="1">Character timer 2.</td>
</tr>
<tr>
<td class="asm-label">CUSTOMER_3_TIMER</td>
<td class="address-1"><span id="d498"></span>D498</td>
<td class="instruction">DEFB $00</td>
<td class="comment-1" rowspan="1">Character timer 3.</td>
</tr>
<tr>
<td class="asm-label">CUSTOMER_4_TIMER</td>
<td class="address-1"><span id="d499"></span>D499</td>
<td class="instruction">DEFB $1E</td>
<td class="comment-1" rowspan="1">Character timer 4.</td>
</tr>
<tr>
<td class="asm-label">CUSTOMER_5_TIMER</td>
<td class="address-1"><span id="d49a"></span>D49A</td>
<td class="instruction">DEFB $0C</td>
<td class="comment-1" rowspan="1">Character timer 5.</td>
</tr>
<tr>
<td class="asm-label">CUSTOMER_6_TIMER</td>
<td class="address-1"><span id="d49b"></span>D49B</td>
<td class="instruction">DEFB $06</td>
<td class="comment-1" rowspan="1">Character timer 6.</td>
</tr>
<tr>
<td class="asm-label">CUSTOMER_7_TIMER</td>
<td class="address-1"><span id="d49c"></span>D49C</td>
<td class="instruction">DEFB $08</td>
<td class="comment-1" rowspan="1">Character timer 7.</td>
</tr>
<tr>
<td class="asm-label">CUSTOMER_8_TIMER</td>
<td class="address-1"><span id="d49d"></span>D49D</td>
<td class="instruction">DEFB $08</td>
<td class="comment-1" rowspan="1">Character timer 8.</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="d49e"></span>
<div class="comments">
<div class="paragraph">
This routine looks at the current character state and routes to the correct subroutine.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label">CUSTOMER_ROUTING</td>
<td class="address-2"><span id="d49e"></span>D49E</td>
<td class="instruction">LD HL,$D495</td>
<td class="comment-1" rowspan="2"><span class="register">A</span>=<a href="D48F.html#d495">CUSTOMER_STATE_REF</a>.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="d4a1"></span>D4A1</td>
<td class="instruction">LD A,(HL)</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="d4a2"></span>D4A2</td>
<td class="instruction">DEC A</td>
<td class="comment-1" rowspan="15">Work out which routine to use based on the current state. <table class="default">
<tr>
<th colspan="1" rowspan="1"><span class="register">A</span></th>
<th colspan="1" rowspan="1">Routine</th>
</tr>
<tr>
<td class="centre" colspan="1" rowspan="1">$01</td>
<td class="centre" colspan="1" rowspan="1"><a href="D48F.html#d4bd">CUSTOMER_OPEN_1</a></td>
</tr>
<tr>
<td class="centre" colspan="1" rowspan="1">$02</td>
<td class="centre" colspan="1" rowspan="1"><a href="D48F.html#d4cd">CUSTOMER_OPEN_2</a></td>
</tr>
<tr>
<td class="centre" colspan="1" rowspan="1">$03</td>
<td class="centre" colspan="1" rowspan="1"><a href="D48F.html#d4dd">CUSTOMER_OPEN_3</a></td>
</tr>
<tr>
<td class="centre" colspan="1" rowspan="1">$04</td>
<td class="centre" colspan="1" rowspan="1"><a href="D48F.html#d4ed">CUSTOMER_OPEN_4</a></td>
</tr>
<tr>
<td class="centre" colspan="1" rowspan="1">$05</td>
<td class="centre" colspan="1" rowspan="1"><a href="D48F.html#d524">CUSTOMER_UNCOVER</a></td>
</tr>
<tr>
<td class="centre" colspan="1" rowspan="1">$06</td>
<td class="centre" colspan="1" rowspan="1"><a href="D48F.html#d540">CUSTOMER_CLOSE_3</a></td>
</tr>
<tr>
<td class="centre" colspan="1" rowspan="1">$07</td>
<td class="centre" colspan="1" rowspan="1"><a href="D48F.html#d559">CUSTOMER_CLOSE_2</a></td>
</tr>
<tr>
<td class="centre" colspan="1" rowspan="1">$08</td>
<td class="centre" colspan="1" rowspan="1"><a href="D48F.html#d56c">CUSTOMER_CLOSE_1</a></td>
</tr>
</table></td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="d4a3"></span>D4A3</td>
<td class="instruction">JR Z,<a href="D48F.html#d4bd">CUSTOMER_OPEN_1</a></td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="d4a5"></span>D4A5</td>
<td class="instruction">DEC A</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="d4a6"></span>D4A6</td>
<td class="instruction">JR Z,<a href="D48F.html#d4cd">CUSTOMER_OPEN_2</a></td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="d4a8"></span>D4A8</td>
<td class="instruction">DEC A</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="d4a9"></span>D4A9</td>
<td class="instruction">JR Z,<a href="D48F.html#d4dd">CUSTOMER_OPEN_3</a></td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="d4ab"></span>D4AB</td>
<td class="instruction">DEC A</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="d4ac"></span>D4AC</td>
<td class="instruction">JR Z,<a href="D48F.html#d4ed">CUSTOMER_OPEN_4</a></td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="d4ae"></span>D4AE</td>
<td class="instruction">DEC A</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="d4af"></span>D4AF</td>
<td class="instruction">JP Z,<a href="D48F.html#d524">CUSTOMER_UNCOVER</a></td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="d4b2"></span>D4B2</td>
<td class="instruction">DEC A</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="d4b3"></span>D4B3</td>
<td class="instruction">JP Z,<a href="D48F.html#d540">CUSTOMER_CLOSE_3</a></td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="d4b6"></span>D4B6</td>
<td class="instruction">DEC A</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="d4b7"></span>D4B7</td>
<td class="instruction">JP Z,<a href="D48F.html#d559">CUSTOMER_CLOSE_2</a></td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="d4ba"></span>D4BA</td>
<td class="instruction">JP <a href="D48F.html#d56c">CUSTOMER_CLOSE_1</a></td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="d4bd"></span>
<div class="comments">
<div class="paragraph">
Handle door frame 1 countdown/ transition to door frame 2.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label">CUSTOMER_OPEN_1</td>
<td class="address-2"><span id="d4bd"></span>D4BD</td>
<td class="instruction">LD A,($D496)</td>
<td class="comment-1" rowspan="4">Decrease <a href="D48F.html#d496">CUSTOMER_1_TIMER</a> by one, return if result is not zero.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="d4c0"></span>D4C0</td>
<td class="instruction">DEC A</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="d4c1"></span>D4C1</td>
<td class="instruction">LD ($D496),A</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="d4c4"></span>D4C4</td>
<td class="instruction">RET NZ</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="d4c5"></span>D4C5</td>
<td class="instruction">INC (HL)</td>
<td class="comment-1" rowspan="1">Move onto next character state.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="d4c6"></span>D4C6</td>
<td class="instruction">LD A,($D48F)</td>
<td class="comment-1" rowspan="1">Grab the character frame index from <a href="D48F.html">CUSTOMER_FRAME_1</a>.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="d4c9"></span>D4C9</td>
<td class="instruction">CALL <a href="D664.html#d6d1">DRAW_DOOR_FRAME_2</a></td>
<td class="comment-1" rowspan="2">Call <a href="D664.html#d6d1">DRAW_DOOR_FRAME_2</a> and return.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="d4cc"></span>D4CC</td>
<td class="instruction">RET</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="d4cd"></span>
<div class="comments">
<div class="paragraph">
Handle door frame 2 countdown/ transition to door frame 3.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label">CUSTOMER_OPEN_2</td>
<td class="address-2"><span id="d4cd"></span>D4CD</td>
<td class="instruction">LD A,($D497)</td>
<td class="comment-1" rowspan="4">Decrease <a href="D48F.html#d497">CUSTOMER_2_TIMER</a> by one, return if result is not zero.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="d4d0"></span>D4D0</td>
<td class="instruction">DEC A</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="d4d1"></span>D4D1</td>
<td class="instruction">LD ($D497),A</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="d4d4"></span>D4D4</td>
<td class="instruction">RET NZ</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="d4d5"></span>D4D5</td>
<td class="instruction">INC (HL)</td>
<td class="comment-1" rowspan="1">Move onto next character state.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="d4d6"></span>D4D6</td>
<td class="instruction">LD A,($D48F)</td>
<td class="comment-1" rowspan="1">Grab the character frame index from <a href="D48F.html">CUSTOMER_FRAME_1</a>.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="d4d9"></span>D4D9</td>
<td class="instruction">CALL <a href="D664.html#d6df">DRAW_DOOR_FRAME_3</a></td>
<td class="comment-1" rowspan="2">Call <a href="D664.html#d6df">DRAW_DOOR_FRAME_3</a> and return.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="d4dc"></span>D4DC</td>
<td class="instruction">RET</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="d4dd"></span>
<div class="comments">
<div class="paragraph">
Handle door frame 3 countdown/ transition to door frame 4.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label">CUSTOMER_OPEN_3</td>
<td class="address-2"><span id="d4dd"></span>D4DD</td>
<td class="instruction">LD A,($D498)</td>
<td class="comment-1" rowspan="4">Decrease <a href="D48F.html#d498">CUSTOMER_3_TIMER</a> by one, return if result is not zero.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="d4e0"></span>D4E0</td>
<td class="instruction">DEC A</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="d4e1"></span>D4E1</td>
<td class="instruction">LD ($D498),A</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="d4e4"></span>D4E4</td>
<td class="instruction">RET NZ</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="d4e5"></span>D4E5</td>
<td class="instruction">INC (HL)</td>
<td class="comment-1" rowspan="1">Move onto next character state.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="d4e6"></span>D4E6</td>
<td class="instruction">LD A,($D48F)</td>
<td class="comment-1" rowspan="1">Grab the character frame index from <a href="D48F.html">CUSTOMER_FRAME_1</a>.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="d4e9"></span>D4E9</td>
<td class="instruction">CALL <a href="D664.html#d6ed">DRAW_DOOR_FRAME_4</a></td>
<td class="comment-1" rowspan="2">Call <a href="D664.html#d6ed">DRAW_DOOR_FRAME_4</a> and return.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="d4ec"></span>D4EC</td>
<td class="instruction">RET</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="d4ed"></span>
<div class="comments">
<div class="paragraph">
Handle door frame 4 timer...
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label">CUSTOMER_OPEN_4</td>
<td class="address-2"><span id="d4ed"></span>D4ED</td>
<td class="instruction">LD DE,$CF91</td>
<td class="comment-1" rowspan="2">Calls <a href="D5A3.html">HIT_DETECTION</a> with <span class="register">DE</span>=<a href="CEB8.html#cf91">INIT_CUSTOMER_SHOT</a>.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="d4f0"></span>D4F0</td>
<td class="instruction">CALL <a href="D5A3.html">HIT_DETECTION</a></td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="d4f3"></span>D4F3</td>
<td class="instruction">LD A,($D499)</td>
<td class="comment-1" rowspan="4">Decrease <a href="D48F.html#d499">CUSTOMER_4_TIMER</a> by one, return if result is not zero.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="d4f6"></span>D4F6</td>
<td class="instruction">DEC A</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="d4f7"></span>D4F7</td>
<td class="instruction">LD ($D499),A</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="d4fa"></span>D4FA</td>
<td class="instruction">RET NZ</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="d4fb"></span>D4FB</td>
<td class="instruction">LD A,($D494)</td>
<td class="comment-1" rowspan="3">Jump to <a href="D48F.html#d516">CUSTOMER_HANDS_UP</a> if <a href="D48F.html#d494">CUSTOMER_FLAG_UNCOVER</a> is not zero.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="d4fe"></span>D4FE</td>
<td class="instruction">AND A</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="d4ff"></span>D4FF</td>
<td class="instruction">JR NZ,<a href="D48F.html#d516">CUSTOMER_HANDS_UP</a></td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="d501"></span>D501</td>
<td class="instruction">LD (HL),$07</td>
<td class="comment-1" rowspan="1">Set <a href="D48F.html#d495">CUSTOMER_STATE_REF</a> to use state $07 (<a href="D48F.html#d559">CUSTOMER_CLOSE_2</a> on the next call to <a href="D48F.html#d49e">CUSTOMER_ROUTING</a>).</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="d503"></span>D503</td>
<td class="instruction">LD A,($D48F)</td>
<td class="comment-1" rowspan="2">Call <a href="D664.html#d6df">DRAW_DOOR_FRAME_3</a> using the character frame index from <a href="D48F.html">CUSTOMER_FRAME_1</a>.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="d506"></span>D506</td>
<td class="instruction">CALL <a href="D664.html#d6df">DRAW_DOOR_FRAME_3</a></td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="d509"></span>D509</td>
<td class="instruction">LD (IX+$06),$05</td>
<td class="comment-1" rowspan="1">Issue 500 points (by writing $05 to the high order byte of, e.g. <a href="D165.html#d16b">DOOR_1_SCORING</a>).</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="d50d"></span>D50D</td>
<td class="instruction">LD A,$01</td>
<td class="comment-1" rowspan="2">Register this as a deposit (by writing $01 to e.g. <a href="D165.html#d16d">DOOR_1_CASH_ACTION</a>).</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="d50f"></span>D50F</td>
<td class="instruction">LD (IX+$08),A</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="d512"></span>D512</td>
<td class="instruction">LD ($D190),A</td>
<td class="comment-1" rowspan="1">Writes $01 to <a href="D190.html">D190</a>.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="d515"></span>D515</td>
<td class="instruction">RET</td>
<td class="comment-1" rowspan="1">Return.</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="d516"></span>
<div class="comments">
<div class="paragraph">
Handle customer putting their hands up.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label">CUSTOMER_HANDS_UP</td>
<td class="address-2"><span id="d516"></span>D516</td>
<td class="instruction">LD A,($D495)</td>
<td class="comment-1" rowspan="3">Increase <a href="D48F.html#d495">CUSTOMER_STATE_REF</a> by one.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="d519"></span>D519</td>
<td class="instruction">INC A</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="d51a"></span>D51A</td>
<td class="instruction">LD ($D495),A</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="d51d"></span>D51D</td>
<td class="instruction">LD A,($D490)</td>
<td class="comment-1" rowspan="1">Grab the character frame index from <a href="D48F.html#d490">CUSTOMER_FRAME_2</a>.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="d520"></span>D520</td>
<td class="instruction">CALL <a href="D664.html#d6ed">DRAW_DOOR_FRAME_4</a></td>
<td class="comment-1" rowspan="2">Call <a href="D664.html#d6ed">DRAW_DOOR_FRAME_4</a> and return.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="d523"></span>D523</td>
<td class="instruction">RET</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="d524"></span>
<div class="comments">
<div class="paragraph">
Handles customer uncovering a "hidden" bandit action.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label">CUSTOMER_UNCOVER</td>
<td class="address-2"><span id="d524"></span>D524</td>
<td class="instruction">LD DE,$CF91</td>
<td class="comment-1" rowspan="2">Calls <a href="D5A3.html">HIT_DETECTION</a> with <span class="register">DE</span>=<a href="CEB8.html#cf91">INIT_CUSTOMER_SHOT</a>.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="d527"></span>D527</td>
<td class="instruction">CALL <a href="D5A3.html">HIT_DETECTION</a></td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="d52a"></span>D52A</td>
<td class="instruction">LD A,($D49A)</td>
<td class="comment-1" rowspan="4">Decrease <a href="D48F.html#d49a">CUSTOMER_5_TIMER</a> by one, return if result is not zero.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="d52d"></span>D52D</td>
<td class="instruction">DEC A</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="d52e"></span>D52E</td>
<td class="instruction">LD ($D49A),A</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="d531"></span>D531</td>
<td class="instruction">RET NZ</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="d532"></span>D532</td>
<td class="instruction">LD A,($D495)</td>
<td class="comment-1" rowspan="3">Increase <a href="D48F.html#d495">CUSTOMER_STATE_REF</a> by one.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="d535"></span>D535</td>
<td class="instruction">INC A</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="d536"></span>D536</td>
<td class="instruction">LD ($D495),A</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="d539"></span>D539</td>
<td class="instruction">LD A,($D491)</td>
<td class="comment-1" rowspan="1">Grab the character frame index from <a href="D48F.html#d491">CUSTOMER_FRAME_3</a>.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="d53c"></span>D53C</td>
<td class="instruction">CALL <a href="D664.html#d6ed">DRAW_DOOR_FRAME_4</a></td>
<td class="comment-1" rowspan="2">Call <a href="D664.html#d6ed">DRAW_DOOR_FRAME_4</a> and return.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="d53f"></span>D53F</td>
<td class="instruction">RET</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="d540"></span>
<div class="comments">
<div class="paragraph">
Handle door frame 4 countdown/ transition to door frame 3.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label">CUSTOMER_CLOSE_3</td>
<td class="address-2"><span id="d540"></span>D540</td>
<td class="instruction">LD A,($D49B)</td>
<td class="comment-1" rowspan="4">Decrease <a href="D48F.html#d49b">CUSTOMER_6_TIMER</a> by one, return if result is not zero.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="d543"></span>D543</td>
<td class="instruction">DEC A</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="d544"></span>D544</td>
<td class="instruction">LD ($D49B),A</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="d547"></span>D547</td>
<td class="instruction">RET NZ</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="d548"></span>D548</td>
<td class="instruction">CALL <a href="CEB8.html">INIT_BANDIT_OPEN</a></td>
<td class="comment-1" rowspan="1">Call <a href="CEB8.html">INIT_BANDIT_OPEN</a>.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="d54b"></span>D54B</td>
<td class="instruction">LD L,(IX+$02)</td>
<td class="comment-1" rowspan="3">Load, e.g. <a href="D165.html#d167">DOOR_1_SOURCE</a> (bandit source data) into <span class="register">HL</span>, and write $03 to the address contained in it.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="d54e"></span>D54E</td>
<td class="instruction">LD H,(IX+$03)</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="d551"></span>D551</td>
<td class="instruction">LD (HL),$03</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="d553"></span>D553</td>
<td class="instruction">INC HL</td>
<td class="comment-1" rowspan="4">Increase the pointer to the bandit source data by 3 and write $04 to this byte.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="d554"></span>D554</td>
<td class="instruction">INC HL</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="d555"></span>D555</td>
<td class="instruction">INC HL</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="d556"></span>D556</td>
<td class="instruction">LD (HL),$04</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="d558"></span>D558</td>
<td class="instruction">RET</td>
<td class="comment-1" rowspan="1">Return.</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="d559"></span>
<div class="comments">
<div class="paragraph">
Handle door frame 3 countdown/ transition to door frame 2.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label">CUSTOMER_CLOSE_2</td>
<td class="address-2"><span id="d559"></span>D559</td>
<td class="instruction">LD A,($D49C)</td>
<td class="comment-1" rowspan="4">Decrease <a href="D48F.html#d49c">CUSTOMER_7_TIMER</a> by one, return if result is not zero.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="d55c"></span>D55C</td>
<td class="instruction">DEC A</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="d55d"></span>D55D</td>
<td class="instruction">LD ($D49C),A</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="d560"></span>D560</td>
<td class="instruction">RET NZ</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="d561"></span>D561</td>
<td class="instruction">LD HL,$D495</td>
<td class="comment-1" rowspan="2">Increase <a href="D48F.html#d495">CUSTOMER_STATE_REF</a> by one.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="d564"></span>D564</td>
<td class="instruction">INC (HL)</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="d565"></span>D565</td>
<td class="instruction">LD A,($D48F)</td>
<td class="comment-1" rowspan="1">Grab the character frame index from <a href="D48F.html">CUSTOMER_FRAME_1</a>.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="d568"></span>D568</td>
<td class="instruction">CALL <a href="D664.html#d6d1">DRAW_DOOR_FRAME_2</a></td>
<td class="comment-1" rowspan="2">Call <a href="D664.html#d6d1">DRAW_DOOR_FRAME_2</a> and return.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="d56b"></span>D56B</td>
<td class="instruction">RET</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="d56c"></span>
<div class="comments">
<div class="paragraph">
Handle door frame 2 countdown/ transition to door frame 1.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label">CUSTOMER_CLOSE_1</td>
<td class="address-2"><span id="d56c"></span>D56C</td>
<td class="instruction">LD A,($D49D)</td>
<td class="comment-1" rowspan="4">Decrease <a href="D48F.html#d49d">CUSTOMER_8_TIMER</a> by one, return if result is not zero.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="d56f"></span>D56F</td>
<td class="instruction">DEC A</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="d570"></span>D570</td>
<td class="instruction">LD ($D49D),A</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="d573"></span>D573</td>
<td class="instruction">RET NZ</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="d574"></span>D574</td>
<td class="instruction">CALL <a href="D664.html">DRAW_DOOR_FRAME_1</a></td>
<td class="comment-1" rowspan="1">Call <a href="D664.html">DRAW_DOOR_FRAME_1</a> (i.e. no character/ door is shut).</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="d577"></span>D577</td>
<td class="instruction">CALL <a href="D8A1.html">RESET___</a></td>
<td class="comment-1" rowspan="2">Call <a href="D8A1.html">RESET___</a> and return.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="d57a"></span>D57A</td>
<td class="instruction">RET</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="d57b"></span>
<div class="comments">
<div class="paragraph">
Handles customer being shot.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label">CUSTOMER_SHOT</td>
<td class="address-2"><span id="d57b"></span>D57B</td>
<td class="instruction">LD HL,$D495</td>
<td class="comment-1" rowspan="5">If <a href="D48F.html#d495">CUSTOMER_STATE_REF</a> is zero then jump to <a href="D48F.html#d584">CUSTOMER_SHOT_MIDAIR</a> else jump to <a href="D48F.html#d58c">CUSTOMER_SHOT_FLOOR</a>.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="d57e"></span>D57E</td>
<td class="instruction">LD A,(HL)</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="d57f"></span>D57F</td>
<td class="instruction">DEC A</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="d580"></span>D580</td>
<td class="instruction">JR Z,<a href="D48F.html#d584">CUSTOMER_SHOT_MIDAIR</a></td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="d582"></span>D582</td>
<td class="instruction">JR <a href="D48F.html#d58c">CUSTOMER_SHOT_FLOOR</a></td>
</tr>
<tr>
<td class="asm-label">CUSTOMER_SHOT_MIDAIR</td>
<td class="address-2"><span id="d584"></span>D584</td>
<td class="instruction">INC (HL)</td>
<td class="comment-1" rowspan="1">Move onto next character state.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="d585"></span>D585</td>
<td class="instruction">LD A,($D492)</td>
<td class="comment-1" rowspan="1">Grab the character frame index from <a href="D48F.html#d492">CUSTOMER_FRAME_4</a>.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="d588"></span>D588</td>
<td class="instruction">CALL <a href="D664.html#d6ed">DRAW_DOOR_FRAME_4</a></td>
<td class="comment-1" rowspan="2">Call <a href="D664.html#d6ed">DRAW_DOOR_FRAME_4</a> and return.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="d58b"></span>D58B</td>
<td class="instruction">RET</td>
</tr>
<tr>
<td class="asm-label">CUSTOMER_SHOT_FLOOR</td>
<td class="address-2"><span id="d58c"></span>D58C</td>
<td class="instruction">LD A,($D497)</td>
<td class="comment-1" rowspan="4">Decrease <a href="D48F.html#d497">CUSTOMER_2_TIMER</a> by one, return if result is not zero.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="d58f"></span>D58F</td>
<td class="instruction">DEC A</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="d590"></span>D590</td>
<td class="instruction">LD ($D497),A</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="d593"></span>D593</td>
<td class="instruction">RET NZ</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="d594"></span>D594</td>
<td class="instruction">LD A,($D493)</td>
<td class="comment-1" rowspan="1">Grab the character frame index from <a href="D48F.html#d493">CUSTOMER_FRAME_5</a>.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="d597"></span>D597</td>
<td class="instruction">CALL <a href="D664.html#d6ed">DRAW_DOOR_FRAME_4</a></td>
<td class="comment-1" rowspan="1">Call <a href="D664.html#d6ed">DRAW_DOOR_FRAME_4</a>.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="d59a"></span>D59A</td>
<td class="instruction">LD A,$02</td>
<td class="comment-1" rowspan="2">Writes $02 to <a href="D2CF.html#d2fe">D2FE</a>.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="d59c"></span>D59C</td>
<td class="instruction">LD ($D2FE),A</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="d59f"></span>D59F</td>
<td class="instruction">CALL <a href="D8A1.html">RESET___</a></td>
<td class="comment-1" rowspan="2">Call <a href="D8A1.html">RESET___</a> and return.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="d5a2"></span>D5A2</td>
<td class="instruction">RET</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev">
Prev: <a href="D45E.html">D45E</a>
</td>
<td class="up">Up: <a href="../maps/all.html#d48f">Map</a></td>
<td class="next">
Next: <a href="D5A3.html">D5A3</a>
</td>
</tr>
</table>
<footer>
<div class="release"></div>
<div class="copyright">&copy; DINAMIC SOFTWARE 1985</div>
<div class="created">Created using <a href="https://skoolkit.ca">SkoolKit</a> 8.6.</div>
<div><a href="../dec/asm/54415.html">Switch to decimal</a>.</div>
</footer>
</body>
</html>